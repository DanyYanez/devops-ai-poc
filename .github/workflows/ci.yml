name: CI/CD with AI Analysis

on:
  push:
    branches: [ main, uat, develop ]
  pull_request:
    branches: [ main, uat, develop ]

jobs:
  test-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-json-report anthropic
    
    - name: Run tests with JSON output
      run: |
        pytest tests/ \
          --json-report \
          --json-report-file=test-results.json \
          -v 2>&1 | tee test-output.txt
      continue-on-error: true
    
    - name: Run LLM Analysis
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: python scripts/analyze.py
      continue-on-error: true
    
    - name: Upload Analysis Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-${{ github.ref_name }}-${{ github.run_number }}-${{ github.run_id }}
        path: analysis-report.html
    
    - name: Post summary to job
      if: always()
      run: |
        if [ -f test-results.json ]; then
          python << 'EOF'
        import json

        with open('test-results.json', 'r') as f:
            data = json.load(f)

        summary = data.get('summary', {})
        passed = summary.get('passed', 0)
        failed = summary.get('failed', 0)
        total = summary.get('total', 0)

        status_icon = "‚úÖ" if failed == 0 else "‚ùå"
        status_text = "PASSED" if failed == 0 else "FAILED"

        md = f"""## {status_icon} CI/CD Analysis Report - {status_text}

| Metric | Count |
|--------|-------|
| üìä Total Tests | {total} |
| ‚úÖ Passed | {passed} |
| ‚ùå Failed | {failed} |

"""

        if failed > 0:
            md += "### ‚ùå Failed Tests\n\n"
            for test in data.get('tests', []):
                if test.get('outcome') == 'failed':
                    test_name = test.get('nodeid', 'Unknown')
                    # Extract just the test name for readability
                    short_name = test_name.split('::')[-1] if '::' in test_name else test_name
                    file_path = test_name.split('::')[0] if '::' in test_name else ''
                    
                    md += f"- **{short_name}**\n"
                    md += f"  - üìÅ File: `{file_path}`\n"
                    
                    # Get error message
                    call_info = test.get('call', {})
                    crash = call_info.get('crash', {})
                    if crash:
                        message = crash.get('message', '')[:200]
                        if message:
                            md += f"  - üí¨ Error: `{message}`\n"
                    md += "\n"

        md += "\n---\nüìé View full HTML report in Artifacts section"

        with open('$GITHUB_STEP_SUMMARY', 'a') as f:
            f.write(md)
        EOF
        fi
    
    - name: Comment on commit if tests fail
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('test-results.json')) {
            const results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
            const failed = results.summary?.failed || 0;
            const passed = results.summary?.passed || 0;
            const total = results.summary?.total || 0;
            
            if (failed > 0) {
              let failedTests = '';
              for (const test of results.tests || []) {
                if (test.outcome === 'failed') {
                  const testName = test.nodeid?.split('::').pop() || 'Unknown';
                  const filePath = test.nodeid?.split('::')[0] || '';
                  const errorMsg = test.call?.crash?.message?.substring(0, 150) || 'No details';
                  failedTests += `- **${testName}**\n  - File: \`${filePath}\`\n  - Error: \`${errorMsg}\`\n`;
                }
              }
              
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: `## ‚ùå CI Failed

| Metric | Count |
|--------|-------|
| Total | ${total} |
| ‚úÖ Passed | ${passed} |
| ‚ùå Failed | ${failed} |

### Failed Tests:
${failedTests}

üîó [View AI Analysis Report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
              });
            }
          }
    
    - name: Fail if tests failed
      if: always()
      run: |
        if [ -f test-results.json ]; then
          FAILED=$(python -c "import json; d=json.load(open('test-results.json')); print(d.get('summary',{}).get('failed',0))")
          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi
        fi